<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åŸæ–™ åœ¨åº«ç®¡ç†</title>
  <style>
    /* â€”â€” ãƒ™ãƒ¼ã‚¹ â€”â€” */
    :root { --bg:#0f1115; --card:#171923; --ink:#e8ebf1; --muted:#aab2c5; --accent:#7dcfff; --danger:#ff6b6b; --ok:#8be9a8; }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background:linear-gradient(180deg, #0e0f13, #12141b 20%, #0e0f13); color:var(--ink); }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin: 8px 0 12px; }
    h1 { font-size: clamp(20px, 4.5vw, 28px); font-weight: 700; margin:0; letter-spacing: .03em; }
    .sub { color: var(--muted); font-size: 12px; }

    /* â€”â€” ã‚«ãƒ¼ãƒ‰ â€”â€” */
    .card { background: var(--card); border: 1px solid #222433; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .grid { display:grid; gap:12px; }
    @media (min-width: 720px){ .grid-2 { grid-template-columns: 1.2fr .8fr; } }

    /* â€”â€” ãƒ•ã‚©ãƒ¼ãƒ  â€”â€” */
    form { display:grid; grid-template-columns: 1fr; gap:10px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="number"] { width:100%; box-sizing:border-box; border-radius:10px; background:#0d0f15; border:1px solid #272a3a; color:var(--ink); padding:12px 12px; font-size:16px; outline:none; }
    input[type="number"]::-webkit-outer-spin-button, 
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button, label.filelike { appearance:none; border:none; border-radius:10px; padding:12px 14px; font-size:15px; font-weight:600; letter-spacing:.02em; cursor:pointer; background:#1f2231; color:var(--ink); border:1px solid #2a2e42; }
    button.primary { background: linear-gradient(180deg,#1b7fff,#1957ff); border-color:#1b57ff; }
    button.ghost { background: transparent; }
    button.ok { background: linear-gradient(180deg,#22b07d,#0b8e55); border-color:#0b8e55; }
    button.danger { background: linear-gradient(180deg,#ea6363,#d14a4a); border-color:#d14a4a; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    /* â€”â€” ãƒ†ãƒ¼ãƒ–ãƒ« â€”â€” */
    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-size:12px; font-weight:700; color:var(--muted); padding:10px; border-bottom:1px solid #2a2d41; position:sticky; top:0; background:linear-gradient(180deg,#1a1c27,#161824); }
    tbody td { padding:12px 10px; border-bottom:1px solid #202233; font-size:15px; vertical-align:middle; }
    tbody tr:hover { background:#121424; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2e42; color:var(--muted); background:#10121a; }

    .footerbar { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:12px; }
    .totals { display:flex; gap:12px; }

    /* ãƒ¢ãƒã‚¤ãƒ«ã®æŠ¼ã—ã‚„ã™ã• */
    .tap { min-height:44px; }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’éš ã—ã¦ãƒ©ãƒ™ãƒ«ã§è¦‹ã›ã‚‹ */
    input[type=file]{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>åŸæ–™ åœ¨åº«ç®¡ç†</h1>
        <div class="sub">Androidãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œ / JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾å¿œ / è‡ªå‹•ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ / èª¿æ•´å…¥åŠ›å¯¾å¿œ</div>
      </div>
      <div class="pill" id="status">æœªä¿å­˜</div>
    </header>

    <div class="grid grid-2">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <h2 style="margin:0 0 10px; font-size:18px;">å…¥åŠ›</h2>
        <form id="entryForm">
          <div>
            <label for="name">åŸæ–™ã®åå‰</label>
            <input id="name" name="name" type="text" inputmode="kana" placeholder="ä¾‹ï¼šç¢¾æ£’ã€€5mm" required />
          </div>
          <div class="row">
            <div>
              <label for="palettes">ãƒ‘ãƒ¬ãƒƒãƒˆæ•°</label>
              <input id="palettes" name="palettes" type="number" inputmode="numeric" min="0" step="1" placeholder="0" required />
            </div>
            <div>
              <label for="bags">è¢‹ã®æœ¬æ•°</label>
              <input id="bags" name="bags" type="number" inputmode="numeric" min="0" step="1" placeholder="0" required />
            </div>
          </div>
          <div class="btns">
            <button class="primary tap" type="submit" id="submitBtn">è¿½åŠ  / ä¸Šæ›¸ã</button>
            <button class="ghost tap" type="button" id="resetBtn">ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="sub" style="margin-top:6px;">â€»åŒåã®åŸæ–™ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€Œä¸Šæ›¸ãã€ã«ãªã‚Šã¾ã™ã€‚ç·¨é›†ã¯ä¸€è¦§ã®âœï¸ã‹ã‚‰ã‚‚å¯èƒ½ã€‚</div>
      </form>
      </section>

      <!-- æ“ä½œã‚¨ãƒªã‚¢ -->
      <section class="card">
        <h2 style="margin:0 0 10px; font-size:18px;">ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿</h2>
        <div class="btns" style="margin-bottom:8px;">
          <button class="ok tap" id="exportBtn" type="button">JSONã«æ›¸ãå‡ºã™ï¼ˆä¿å­˜ï¼‰</button>

          <label for="importFile" class="filelike tap">JSONã‚’èª­ã¿è¾¼ã‚€ï¼ˆå¾©å…ƒï¼‰</label>
          <input id="importFile" type="file" accept="application/json" />

          <button class="danger tap" id="clearBtn" type="button">å…¨ã¦å‰Šé™¤</button>
        </div>
        <div class="sub">ãƒ»Androidã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeæ¨å¥¨ï¼‰ã§ä½¿ãˆã¾ã™ã€‚<br>ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆlocalStorageï¼‰ã«ã‚‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨é€”ã«JSONã‚’æ›¸ãå‡ºã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚</div>
      </section>
    </div>

    <!-- ä¸€è¦§ -->
    <section class="card" style="margin-top:12px;">
      <h2 style="margin:0 0 10px; font-size:18px;">åœ¨åº«ä¸€è¦§</h2>
      <div class="footerbar">
        <div class="totals" id="totals">åˆè¨ˆï¼šâ€”</div>
        <div class="sub" id="lastSaved">ä¿å­˜ï¼šâ€”</div>
      </div>
      <div style="overflow:auto; margin-top:8px;">
        <table id="table">
          <thead>
            <tr>
              <th style="min-width:200px;">åŸæ–™å</th>
              <th>ãƒ‘ãƒ¬ãƒƒãƒˆ</th>
              <th>è¢‹æœ¬æ•°</th>
              <th>æ›´æ–°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="text-align:center; color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer class="sub" style="margin:14px 0 24px; text-align:center;">Â© ãŠèŒ¶åœ¨åº«ãƒ¡ãƒ¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ï¼‰</footer>
  </div>

  <script>
  // â€”â€” çŠ¶æ…‹ç®¡ç† â€”â€”
  /** @typedef {{ id:string, name:string, palettes:number, bags:number, updatedAt:string }} Item */
  /** @type {Item[]} */
  let items = [];
  const STORAGE_KEY = 'tea_inventory_v1';

  // â€”â€” è¦ç´ å‚ç…§ â€”â€”
  const form = document.getElementById('entryForm');
  const nameEl = document.getElementById('name');
  const palettesEl = document.getElementById('palettes');
  const bagsEl = document.getElementById('bags');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');
  const clearBtn = document.getElementById('clearBtn');
  const tbody = document.getElementById('tbody');
  const statusPill = document.getElementById('status');
  const totalsEl = document.getElementById('totals');
  const lastSavedEl = document.getElementById('lastSaved');

  // â€”â€” ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â€”â€”
  const nowISO = () => new Date().toISOString();
  const fmtDate = (iso) => new Date(iso).toLocaleString();
  const uid = () => Math.random().toString(36).slice(2,10);

  function setDirty(saved){
    if(saved){ statusPill.textContent = 'ä¿å­˜æ¸ˆã¿'; statusPill.style.background = '#10351e'; statusPill.style.color = '#9de7b8'; }
    else{ statusPill.textContent = 'æœªä¿å­˜'; statusPill.style.background = '#2a2030'; statusPill.style.color = '#ffd6f1'; }
  }

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    setDirty(true);
    lastSavedEl.textContent = 'ä¿å­˜ï¼š' + fmtDate(nowISO());
  }

  function loadFromLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ items = JSON.parse(raw); }
    }catch(e){ console.warn('localStorageèª­ã¿è¾¼ã¿å¤±æ•—', e); items = []; }
  }

  function render(){
    // ã‚½ãƒ¼ãƒˆï¼ˆåå‰æ˜‡é †ï¼‰
    items.sort((a,b)=> a.name.localeCompare(b.name, 'ja'));

    if(items.length === 0){
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</td></tr>';
      totalsEl.textContent = 'åˆè¨ˆï¼šâ€”';
      return;
    }

    tbody.innerHTML = items.map(it => `
      <tr>
        <td>${escapeHtml(it.name)}</td>
        <td>${it.palettes}</td>
        <td>${it.bags}</td>
        <td><span class="sub">${escapeHtml(new Date(it.updatedAt).toLocaleString())}</span></td>
        <td class="actions">
          <button class="ghost tap" data-act="edit" data-id="${it.id}">âœï¸ç·¨é›†</button>
          <button class="ghost tap" data-act="adj" data-id="${it.id}">âš–ï¸èª¿æ•´</button>
          <button class="danger tap" data-act="del" data-id="${it.id}">ğŸ—‘å‰Šé™¤</button>
        </td>
      </tr>
    `).join('');

    const totals = items.reduce((acc, it)=>({pal:acc.pal + Number(it.palettes||0), bag:acc.bag + Number(it.bags||0)}), {pal:0, bag:0});
    totalsEl.textContent = `åˆè¨ˆï¼šãƒ‘ãƒ¬ãƒƒãƒˆ ${totals.pal} / è¢‹ ${totals.bag}`;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>'"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[s]));
  }

  // â€”â€” è¿½åŠ /æ›´æ–° â€”â€”
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = nameEl.value.trim();
    const palettes = Number(palettesEl.value || 0);
    const bags = Number(bagsEl.value || 0);
    if(!name) return;

    // æ—¢å­˜ãƒã‚§ãƒƒã‚¯ï¼ˆåŒåã‚’ä¸Šæ›¸ãã«ã™ã‚‹ï¼‰
    const found = items.find(i => i.name === name);
    if(found){
      found.palettes = palettes;
      found.bags = bags;
      found.updatedAt = nowISO();
    } else {
      items.push({ id: uid(), name, palettes, bags, updatedAt: nowISO() });
    }

    setDirty(false);
    render();
    persist();
    form.reset();
    nameEl.focus();
  });

  resetBtn.addEventListener('click', ()=> form.reset());

  // â€”â€” ç·¨é›†/å‰Šé™¤/èª¿æ•´ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ãƒˆï¼‰ â€”â€”
  tbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const idx = items.findIndex(i=> i.id === id);
    if(idx === -1) return;

    if(act === 'del'){
      if(confirm('ã“ã®åŸæ–™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
        items.splice(idx,1); render(); persist();
      }
    } else if(act === 'edit'){
      const it = items[idx];
      nameEl.value = it.name;
      palettesEl.value = it.palettes;
      bagsEl.value = it.bags;
      nameEl.focus();
    } else if(act === 'adj'){
      const it = items[idx];
      const input = prompt(`èª¿æ•´å€¤ã‚’å…¥åŠ›ï¼ˆä¾‹: "-1PL -16æœ¬" ã¾ãŸã¯ "-1 -16"ï¼‰\nç¾åœ¨: ãƒ‘ãƒ¬ãƒƒãƒˆ ${it.palettes} / è¢‹ ${it.bags}`);
      if(input == null) return;
      try{
        const d = parseDelta(input);
        const np = it.palettes + d.pal;
        const nb = it.bags + d.bag;
        if(np < 0 || nb < 0){
          if(!confirm(`çµæœãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚Šã¾ã™ã€‚é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ\nâ†’ ãƒ‘ãƒ¬ãƒƒãƒˆ ${np} / è¢‹ ${nb}`)) return;
        }
        it.palettes = np;
        it.bags = nb;
        it.updatedAt = nowISO();
        render();
        persist();
      }catch(err){
        alert('ã†ã¾ãèª­ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ä¾‹: "-1PL -16æœ¬" ã¾ãŸã¯ "-1 -16" ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }
    }
  });

  // â€”â€” æ–‡å­—åˆ—ã‹ã‚‰èª¿æ•´å€¤ã‚’èª­ã‚€ â€”â€”
  /** ä¾‹: "-1PL -16æœ¬", "-2 ãƒ‘ãƒ¬ãƒƒãƒˆ +5", "-1 -16" */
  function parseDelta(input){
    const s = String(input || '').replace(/[\u3000\s]+/g,' ').trim();
    if(!s) throw new Error('empty');
    let pal = 0, bag = 0;
    const re = /([+-]?\d+)\s*(pl|ãƒ‘ãƒ¬ãƒƒãƒˆ|è¢‹|æœ¬)?/gi;
    const caps = [];
    let m;
    while((m = re.exec(s))){ caps.push(m); }
    if(caps.length === 0) throw new Error('no number');
    for(const c of caps){
      const val = Number(c[1]);
      const unit = (c[2] || '').toLowerCase();
      if(unit === 'pl' || unit === 'ãƒ‘ãƒ¬ãƒƒãƒˆ'){ pal += val; }
      else if(unit === 'è¢‹' || unit === 'æœ¬'){ bag += val; }
      else {
        // å˜ä½ãªã—ã¯ã€æœªå‰²å½“ã®é †ã§ ãƒ‘ãƒ¬ãƒƒãƒˆâ†’è¢‹ ã«å‰²ã‚Šå½“ã¦
        if(pal === 0) pal += val; else bag += val;
      }
    }
    return { pal, bag };
  }

  // â€”â€” JSONæ›¸ãå‡ºã— â€”â€”
  exportBtn.addEventListener('click', ()=>{
    const payload = { version:1, exportedAt: nowISO(), items };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ymd = new Date().toISOString().slice(0,10).replaceAll('-','');
    a.href = url;
    a.download = `tea_inventory_${ymd}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // â€”â€” JSONèª­ã¿è¾¼ã¿ â€”â€”
  importFile.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!Array.isArray(data.items)) throw new Error('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆitemsé…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰');
      // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const cleaned = data.items.map(x=>({
        id: typeof x.id === 'string' ? x.id : uid(),
        name: String(x.name ?? ''),
        palettes: Number(x.palettes ?? 0),
        bags: Number(x.bags ?? 0),
        updatedAt: typeof x.updatedAt === 'string' ? x.updatedAt : nowISO(),
      })).filter(x=> x.name.trim() !== '');
      items = cleaned;
      render();
      persist();
      importFile.value = '';
      alert('èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
    }catch(err){
      console.error(err); alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
    }
  });

  // â€”â€” å…¨å‰Šé™¤ â€”â€”
  clearBtn.addEventListener('click', ()=>{
    if(confirm('å…¨ã¦ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
      items = []; render(); persist();
    }
  });

  // â€”â€” åˆæœŸåŒ– â€”â€”
  function init(){
    loadFromLocal();
    render();
    setDirty(true);
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ lastSavedEl.textContent = 'ä¿å­˜ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å¾©å…ƒæ¸ˆã¿'; }
  }
  init();
  </script>
</body>
</html>
